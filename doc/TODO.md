# Drift DLOB 做市机器人开发 TODO

本 TODO 依据开发规范拆分为可独立验证的阶段，按顺序推进。每个阶段都包含子任务与可验证产出。

## 阶段 1：环境与工程基础

**目标**：项目可启动、TypeScript 严格模式生效、配置文件结构就绪。

- [x] 初始化 Node.js v20+ 项目结构与依赖清单
- [x] 配置 tsconfig 严格模式与 tsx 运行方式
- [x] 提供 .env.example 与 .env 读取约定
- [x] 创建 config.toml 初始模板并包含所有必需字段
- [x] 建立 logs 目录与 .gitignore 规则

**验收**：项目可在本地用 tsx 启动空入口，配置与环境变量可被读取。

## 阶段 2：配置管理与日志系统 [已完成]

**目标**：可热重载配置，统一日志输出与文件落盘。

- [x] 实现 ConfigManager（load、validate、watch、get、update）
- [x] 完成配置校验规则与类型定义
- [x] 实现 Logger 与日志级别、格式、文件命名规范
- [x] 支持模块名标记与结构化元数据输出

**验收**：修改 config.toml 可触发热重载事件；日志同时输出到控制台与文件。

## 阶段 3：Drift 连接与预言机订阅

**目标**：完成 Drift SDK 初始化与预言机价格事件流。

- [ ] 实现 DriftClientWrapper 初始化、订阅与账户信息获取
- [ ] 处理私钥、RPC、程序 ID 的加载与校验
- [ ] 实现 OracleWatcher，支持订阅、停止与回调
- [ ] 统一价格精度转换为 BN 并包含精度常量

**验收**：可输出实时预言机价格与用户账户信息。

## 阶段 4：订单执行模块

**目标**：实现原子性撤单与挂单，严格遵循 post-only 与 oracle offset。

- [ ] 实现 OrderExecutor 基础方法（place、cancel、cancelAll、getOpenOrders）
- [ ] 实现 cancelAndReplace 原子性更新
- [ ] 统一订单参数构建与精度处理
- [ ] 校验 post-only 与 reduce-only 规则

**验收**：能在 Devnet 成功完成原子撤单并挂新单。

## 阶段 5：策略计算（库存感知报价）

**目标**：基于仓位与预言机价格生成买卖报价与数量。

- [ ] 定义策略类型（PositionSide、QuoteResult、StrategyConfig）
- [ ] 实现 calculateSpread 与库存偏移计算
- [ ] 实现 calculateBidAsk 与 calculateOrderSize
- [ ] 保证所有价格与数量使用 BN 精度

**验收**：输入仓位与价格可得到一致的报价结果与数量。

## 阶段 6：状态机与主循环

**目标**：完成启动模式与做市模式的事件驱动逻辑。

- [ ] 实现 BotEngine 启动、停止与状态同步
- [ ] 实现启动模式：超时检查、价格偏移判断与重挂
- [ ] 实现做市模式：双边挂单、成交取消对手单
- [ ] 管理状态变量与订单生命周期

**验收**：模拟事件可完成一次完整的启动流程与做市轮次。

## 阶段 7：事件处理与风控

**目标**：可处理订单、仓位、预言机事件，并在下单前风控校验。

- [ ] 实现 EventHandler 的成交、取消、仓位变化、价格更新处理
- [ ] 实现 RiskManager 的持仓、敞口、滑点、数量检查
- [ ] 接入紧急平仓与紧急撤单流程

**验收**：触发事件可更新内部状态；风控可拦截违规下单。

## 阶段 8：数据库与权益快照

**目标**：保存账户权益快照并支持查询。

- [ ] 实现 Database 连接管理与初始化
- [ ] 实现 AccountRepo 表结构与查询方法
- [ ] 启动定时任务按配置间隔保存快照

**验收**：数据库可写入并查询最近 N 条权益记录。

## 阶段 9：Web 服务与管理后台

**目标**：提供 API 与 SSR 页面，支持 HTMX 热更新与配置编辑。

- [ ] 选择并集成 Fastify 或 Express 服务器
- [ ] 实现 API 路由：状态、配置、订单、持仓、权益、日志、紧急撤单
- [ ] 实现 Dashboard 页面与控制面板
- [ ] 实现配置编辑器与热重载交互
- [ ] 实现日志轮询与权益曲线展示

**验收**：浏览器可查看状态、控制机器人、更新配置并看到实时日志。

## 阶段 10：稳定性与异常处理

**目标**：全局异常捕获、重试、优雅退出。

- [ ] 实现 uncaughtException 与 unhandledRejection 处理
- [ ] 实现 RPC 与订单确认的指数退避重试
- [ ] 实现 SIGTERM/SIGINT 优雅退出流程

**验收**：模拟异常与退出信号可触发完整清理流程。

## 阶段 11：测试与验收

**目标**：单元测试与集成测试覆盖关键路径。

- [ ] 为核心模块补充单元测试（Logger、Config、Strategy、Risk）
- [ ] 编写集成测试覆盖启动模式与做市模式
- [ ] 在 Devnet 上执行端到端验证
- [ ] 完成验收清单对照与记录

**验收**：测试通过且验收清单全部满足。
