# Drift Protocol DLOB 做市机器人开发计划

本文档将开发计划拆分为9个主要开发阶段，每个阶段包含多个可独立验证的子任务及明确的验收标准。开发阶段按顺序进行，确保每个阶段交付可运行的产物后再进入下一阶段。

---

## 阶段一：环境搭建

### 阶段目标

搭建项目基础骨架，创建完整的开发环境，包括项目初始化、依赖安装、配置文件创建和开发工具配置。这一阶段不涉及业务逻辑，但必须确保所有开发工具能够正常工作。

### 子任务列表

| 序号 | 子任务              | 详细描述                                                                          |
| ---- | ------------------- | --------------------------------------------------------------------------------- |
| 1.1  | 创建项目目录结构    | 按照规范创建完整的目录结构，包括 src/、config/、logs/、db/ 等目录                 |
| 1.2  | 初始化 package.json | 配置项目元数据，添加所有必要的依赖包（TypeScript、Drift SDK、SQLite、Fastify 等） |
| 1.3  | 配置 TypeScript     | 创建 tsconfig.json，启用 Strict Mode，配置编译选项和路径映射                      |
| 1.4  | 创建环境变量文件    | 创建 .env.example 和 .gitignore，定义需要的环境变量模板                           |
| 1.5  | 创建策略配置文件    | 创建 config.toml，包含市场配置、订单参数、报价参数、风控参数等所有配置项          |
| 1.6  | 安装依赖包          | 执行 npm install，确保所有依赖正确安装                                            |

### 验收标准

- [x] 项目目录结构完整，所有目录均已创建
- [x] package.json 包含所有必要的依赖，版本号正确
- [x] tsconfig.json 启用 Strict Mode，编译无错误
- [x] .env.example 包含所有需要的环境变量示例
- [x] config.toml 包含所有配置项，格式正确（有效的 TOML 语法）
- [x] 执行 `npx tsc --noEmit` 无编译错误

---

## 阶段二：基础设施模块

### 阶段目标

实现配置管理模块和日志系统模块，这两个模块是整个系统的基础设施，为后续所有模块提供配置加载和日志输出能力。

### 2.1 配置管理子阶段

#### 子任务列表

| 序号  | 子任务             | 详细描述                                                                                                 |
| ----- | ------------------ | -------------------------------------------------------------------------------------------------------- |
| 2.1.1 | 定义配置类型       | 在 src/config/schema.ts 中定义 Config 接口，包含 market、order、quoting、risk、database、server 等子配置 |
| 2.1.2 | 实现 ConfigManager | 创建 src/config/ConfigManager.ts，实现 load()、validate()、watch()、get()、update() 方法                 |
| 2.1.3 | 实现配置热重载     | 实现文件监听机制，支持配置文件变化时触发 configUpdated 事件                                              |
| 2.1.4 | 编写环境变量加载   | 创建 src/env.ts，实现从 .env 文件加载私钥和 RPC URL                                                      |

#### 验收标准

- [ ] ConfigManager 能够正确解析 config.toml 文件
- [ ] validate() 方法能够校验所有配置项的合法性（数值范围、类型检查）
- [ ] watch() 方法能够监听文件变化并触发回调
- [ ] get() 方法返回只读副本，无法被外部修改
- [ ] update() 方法能够更新配置并触发 configUpdated 事件
- [ ] 单元测试覆盖 ConfigManager 的核心方法

### 2.2 日志系统子阶段

#### 子任务列表

| 序号  | 子任务           | 详细描述                                                                           |
| ----- | ---------------- | ---------------------------------------------------------------------------------- |
| 2.2.1 | 定义日志级别     | 在 src/logger/levels.ts 中定义 LogLevel 枚举，包含 DEBUG、INFO、WARN、ERROR、TRADE |
| 2.2.2 | 实现 Logger 类   | 创建 src/logger/Logger.ts，实现 debug()、info()、warn()、error()、trade() 方法     |
| 2.2.3 | 实现控制台输出   | 实现彩色控制台输出，不同级别使用不同颜色                                           |
| 2.2.4 | 实现文件输出     | 实现日志文件写入，文件名格式为 bot_YYYY-MM-DD_HH-mm-ss.log                         |
| 2.2.5 | 实现日志格式     | 实现统一日志格式：[时间戳] [级别] [模块名] 消息内容 {JSON元数据}                   |
| 2.2.6 | 实现动态级别控制 | 实现 setLevel() 方法，支持运行时动态调整日志级别                                   |

#### 验收标准

- [ ] Logger 支持所有 5 个日志级别
- [ ] 控制台输出使用正确的颜色（DEBUG 灰色、INFO 白色、WARN 黄色、ERROR 红色、TRADE 蓝色）
- [ ] 日志文件正确创建在 logs/ 目录
- [ ] 日志文件命名符合规范（精确到秒）
- [ ] 日志格式符合规范，包含时间戳、级别、模块名、消息和 JSON 元数据
- [ ] setLevel() 能够动态调整日志级别
- [ ] close() 方法正确关闭文件句柄

---

## 阶段三：Drift SDK 连接层

### 阶段目标

实现与 Drift 协议交互的核心封装层，包括 DriftClientWrapper 和 OracleWatcher，为订单执行和策略逻辑提供基础能力。

### 3.1 DriftClientWrapper 子阶段

#### 子任务列表

| 序号  | 子任务                 | 详细描述                                                    |
| ----- | ---------------------- | ----------------------------------------------------------- |
| 3.1.1 | 实现钱包初始化         | 从环境变量加载私钥，创建 Wallet 对象                        |
| 3.1.2 | 实现 Connection 初始化 | 使用 RPC URL 创建 Connection 对象                           |
| 3.1.3 | 实现 DriftClient 创建  | 创建 DriftClient 实例，传入程序 ID 和连接对象               |
| 3.1.4 | 实现 SlotSubscriber    | 初始化 SlotSubscriber 用于同步链上状态                      |
| 3.1.5 | 实现账户订阅           | 订阅用户账户变更事件                                        |
| 3.1.6 | 实现基础查询方法       | 实现 getOraclePrice()、getPosition()、getAccountInfo() 方法 |
| 3.1.7 | 实现订阅管理           | 实现 subscribe() 和 unsubscribe() 方法                      |

#### 验收标准

- [ ] DriftClientWrapper 能够成功连接到 Solana 主网或测试网
- [ ] initialize() 方法正确初始化所有组件
- [ ] getOraclePrice() 返回正确的预言机价格（BN 整数形式）
- [ ] getPosition() 返回当前持仓信息（包含方向和数量）
- [ ] getAccountInfo() 返回完整的账户信息
- [ ] subscribe() 成功订阅账户变更事件
- [ ] unsubscribe() 正确取消订阅，无内存泄漏
- [ ] 能够处理网络异常并抛出有意义的错误信息

### 3.2 OracleWatcher 子阶段

#### 子任务列表

| 序号  | 子任务             | 详细描述                                          |
| ----- | ------------------ | ------------------------------------------------- |
| 3.2.1 | 实现预言机监听启动 | 实现 start() 方法，启动对指定市场的预言机价格监听 |
| 3.2.2 | 实现预言机监听停止 | 实现 stop() 方法，停止监听                        |
| 3.2.3 | 实现价格获取       | 实现 getPrice() 方法，返回当前预言机价格          |
| 3.2.4 | 实现价格回调       | 实现 onPriceUpdate() 方法，注册价格变化回调       |
| 3.2.5 | 实现 BN 精度处理   | 确保所有价格使用 BN 类型，正确处理 Drift 精度常量 |

#### 验收标准

- [ ] OracleWatcher 能够成功订阅预言机价格更新
- [ ] start() 方法接受 marketIndex 参数并正确启动监听
- [ ] getPrice() 返回当前预言机价格（BN 类型）
- [ ] onPriceUpdate() 正确注册回调函数，价格变化时触发回调
- [ ] 使用 Drift SDK 提供的 Oracle 订阅机制（非自行轮询）
- [ ] 价格单位正确（整数形式）

---

## 阶段四：订单执行模块

### 阶段目标

实现 OrderExecutor 类，这是做市策略执行的核心模块，必须严格实现原子性订单操作（cancel-and-replace），确保不会在取消和挂单之间出现空窗期。

### 子任务列表

| 序号 | 子任务                  | 详细描述                                                             |
| ---- | ----------------------- | -------------------------------------------------------------------- |
| 4.1  | 实现原子性取消下单      | 实现 cancelAndReplace() 方法，使用 cancelAndPlaceOrders 保证原子性   |
| 4.2  | 实现单笔下单            | 实现 placeOrder() 方法，支持完整的 OrderParams 参数                  |
| 4.3  | 实现订单取消            | 实现 cancelOrder() 和 cancelAllOrders() 方法                         |
| 4.4  | 实现订单查询            | 实现 getOpenOrders() 方法，获取当前所有挂单                          |
| 4.5  | 实现 post-only 订单     | 确保所有 maker 订单设置 PostOnlyParams.TRY_POST_ONLY                 |
| 4.6  | 实现 oracle offset 订单 | 使用 OrderType.ORACLE 配合 oraclePriceOffset                         |
| 4.7  | 实现 reduce-only 卖单   | 卖单必须设置 reduceOnly = true                                       |
| 4.8  | 实现精度转换            | 实现浮点数到 Drift 整数形式的转换（PRICE_PRECISION、SIZE_PRECISION） |
| 4.9  | 实现重试机制            | 对 RPC 请求实现指数退避重试（1s, 2s, 4s，最多 3 次）                 |

### 验收标准
所有测试必须在mainnet上实际进行，以验证订单模块在真实场景的可靠性
- [ ] cancelAndReplace() 能够在单个交易中完成取消和下单
- [ ] placeOrder() 正确处理所有 OrderParams 参数
- [ ] cancelOrder() 能够取消指定订单
- [ ] cancelAllOrders() 能够取消所有挂单
- [ ] getOpenOrders() 返回当前所有挂单
- [ ] 所有 maker 订单正确设置 post-only
- [ ] 所有卖单正确设置 reduceOnly
- [ ] 价格和数量正确转换为整数形式
- [ ] 网络失败时能够自动重试
- [ ] 单元测试覆盖核心订单操作

---

## 阶段五：策略模块

### 阶段目标

实现库存感知报价策略（Inventory Aware Quoting），根据当前持仓情况动态调整买卖价差，减少库存风险。

### 5.1 策略类型定义子阶段

#### 子任务列表

| 序号  | 子任务           | 详细描述                                                                |
| ----- | ---------------- | ----------------------------------------------------------------------- |
| 5.1.1 | 定义持仓方向枚举 | 在 src/strategy/types.ts 中定义 PositionSide 枚举                       |
| 5.1.2 | 定义报价结果接口 | 定义 QuoteResult 接口，包含 price、size、side、reduceOnly、oracleOffset |
| 5.1.3 | 定义策略配置接口 | 定义 StrategyConfig 接口，包含市场参数和策略参数                        |

#### 验收标准

- [ ] PositionSide 枚举包含 LONG、SHORT、NONE 三个值
- [ ] QuoteResult 接口包含所有必要字段
- [ ] StrategyConfig 接口包含所有策略参数

### 5.2 策略逻辑子阶段

#### 子任务列表

| 序号  | 子任务           | 详细描述                                          |
| ----- | ---------------- | ------------------------------------------------- |
| 5.2.1 | 实现价差计算     | 实现 calculateSpread() 方法，根据持仓计算买卖价差 |
| 5.2.2 | 实现报价计算     | 实现 calculateBidAsk() 方法，计算买卖报价和数量   |
| 5.2.3 | 实现下单数量计算 | 实现 calculateOrderSize() 方法，计算下单数量      |
| 5.2.4 | 实现库存偏移逻辑 | 根据 currentPosition / maxPosition 计算库存偏移   |
| 5.2.5 | 实现动态价差调整 | 当持有多头时增大买单价差、减小卖单价差；反之亦然  |

#### 验收标准

- [ ] calculateSpread() 返回正确的 bidSpread 和 askSpread
- [ ] calculateBidAsk() 返回正确的 bidPrice、askPrice、bidSize、askSize
- [ ] calculateOrderSize() 返回正确的 bidSize 和 askSize
- [ ] 库存偏移逻辑正确：当多头时买单价差增大，卖单价差减小
- [ ] 所有返回值使用 BN 类型
- [ ] 策略逻辑与配置参数正确关联

---

## 阶段六：做市主循环（状态机）

### 阶段目标

实现 BotEngine 类和 EventHandler 类，完整实现做市状态机，包括启动模式、做市模式和状态流转逻辑。

### 6.1 EventHandler 子阶段

#### 子任务列表

| 序号  | 子任务             | 详细描述                                       |
| ----- | ------------------ | ---------------------------------------------- |
| 6.1.1 | 实现订单成交处理   | 实现 onOrderFill() 方法，处理订单成交事件      |
| 6.1.2 | 实现订单取消处理   | 实现 onOrderCancel() 方法，处理订单取消事件    |
| 6.1.3 | 实现仓位变化处理   | 实现 onPositionChange() 方法，处理仓位变化事件 |
| 6.1.4 | 实现预言机更新处理 | 实现 onOracleUpdate() 方法，处理预言机价格更新 |

#### 验收标准

- [ ] onOrderFill() 正确处理订单成交事件
- [ ] onOrderCancel() 正确处理订单取消事件
- [ ] onPositionChange() 正确处理仓位变化事件
- [ ] onOracleUpdate() 正确处理预言机价格更新

### 6.2 BotEngine 子阶段

#### 子任务列表

| 序号   | 子任务             | 详细描述                                                   |
| ------ | ------------------ | ---------------------------------------------------------- |
| 6.2.1  | 实现启动流程       | 实现 start() 方法，完成初始化阶段所有步骤                  |
| 6.2.2  | 实现停止流程       | 实现 stop() 方法，正确清理资源                             |
| 6.2.3  | 实现启动模式       | 实现 runStartupMode() 方法，无仓位时自动挂买单             |
| 6.2.4  | 实现做市模式       | 实现 runMarketMakingMode() 方法，有仓位时同时挂买卖单      |
| 6.2.5  | 实现挂买单逻辑     | 实现 placeBidOrder() 方法                                  |
| 6.2.6  | 实现挂卖单逻辑     | 实现 placeAskOrder() 方法，支持 reduceOnly                 |
| 6.2.7  | 实现对手方订单取消 | 实现 cancelOppositeOrder() 方法                            |
| 6.2.8  | 实现超时检查       | 实现 checkTimeoutAndReposition() 方法，30秒超时后重新挂单  |
| 6.2.9  | 实现状态同步       | 实现 syncState() 方法，同步链上状态                        |
| 6.2.10 | 实现状态机流转     | 实现完整的状态流转逻辑（IDLE -> STARTUP -> MARKET_MAKING） |

#### 验收标准

- [ ] start() 方法正确完成所有初始化步骤
- [ ] stop() 方法正确清理所有资源（取消订单、关闭连接等）
- [ ] runStartupMode() 在无仓位时自动挂买单
- [ ] runMarketMakingMode() 在有仓位时同时挂买单和只减仓卖单
- [ ] 买单使用 post-only，不吃单
- [ ] 卖单使用 reduceOnly，只减仓不平仓
- [ ] 订单成交后自动取消对手方订单
- [ ] 30秒超时逻辑正常工作
- [ ] 预言机偏移订单能够跟随价格浮动
- [ ] 能够处理订单被部分成交的情况
- [ ] 状态机正确处理各种边界情况

---

## 阶段七：风控模块

### 阶段目标

实现 RiskManager 类，在每次下单前进行风控检查，确保机器人运行在安全边界内。

### 子任务列表

| 序号 | 子任务             | 详细描述                                           |
| ---- | ------------------ | -------------------------------------------------- |
| 7.1  | 实现持仓限制检查   | 实现 checkPositionLimit() 方法，检查持仓是否超限   |
| 7.2  | 实现敞口检查       | 实现 checkExposure() 方法，检查 USDC 敞口是否超限  |
| 7.3  | 实现滑点检查       | 实现 checkSlippage() 方法，检查滑点是否过大        |
| 7.4  | 实现订单数量检查   | 实现 checkOrderSize() 方法，检查订单数量是否合规   |
| 7.5  | 实现紧急全平       | 实现 emergencyClose() 方法，紧急情况下取消所有订单 |
| 7.6  | 集成风控到下单流程 | 在 BotEngine 的下单方法中调用风控检查              |

### 验收标准

- [ ] checkPositionLimit() 返回 boolean，超限返回 false
- [ ] checkExposure() 返回 boolean，超限返回 false
- [ ] checkSlippage() 返回 boolean，滑点过大返回 false
- [ ] checkOrderSize() 返回 boolean，数量不合规返回 false
- [ ] emergencyClose() 能够取消所有订单
- [ ] 每次下单前都进行风控检查
- [ ] 风控检查失败时记录警告日志

---

## 阶段八：数据库模块

### 阶段目标

实现 SQLite 数据库模块，记录账户权益快照，为后续分析和监控提供数据支持。

### 8.1 Database 子阶段

#### 子任务列表

| 序号  | 子任务           | 详细描述                                       |
| ----- | ---------------- | ---------------------------------------------- |
| 8.1.1 | 实现数据库初始化 | 在 src/db/Database.ts 中实现 initialize() 方法 |
| 8.1.2 | 实现数据库关闭   | 实现 close() 方法，正确关闭连接                |
| 8.1.3 | 实现连接获取     | 实现 getConnection() 方法，获取数据库连接      |

#### 验收标准

- [ ] initialize() 正确创建数据库连接
- [ ] close() 正确关闭连接，无资源泄漏
- [ ] getConnection() 返回可用的数据库连接

### 8.2 AccountRepo 子阶段

#### 子任务列表

| 序号  | 子任务       | 详细描述                                                |
| ----- | ------------ | ------------------------------------------------------- |
| 8.2.1 | 创建数据库表 | 创建 equity_snapshots 表，包含所有必要字段              |
| 8.2.2 | 实现快照保存 | 实现 saveSnapshot() 方法，保存权益快照                  |
| 8.2.3 | 实现快照查询 | 实现 getSnapshots() 方法，获取最近的快照记录            |
| 8.2.4 | 实现范围查询 | 实现 getSnapshotsInRange() 方法，获取指定时间范围的快照 |
| 8.2.5 | 实现定时任务 | 实现定时保存快照的任务（使用 setInterval）              |

#### 验收标准

- [ ] equity_snapshots 表结构正确，包含所有必要字段
- [ ] saveSnapshot() 正确保存快照数据
- [ ] getSnapshots() 返回最近的 N 条记录
- [ ] getSnapshotsInRange() 返回指定时间范围的记录
- [ ] 定时任务按照配置间隔执行
- [ ] 数据库查询响应时间 < 100ms

---

## 阶段九：Web 服务模块

### 阶段目标

实现 Web 管理后台，使用 HTMX + Tailwind CSS 提供实时监控和配置管理功能。

### 9.1 服务器框架子阶段

#### 子任务列表

| 序号  | 子任务           | 详细描述                                                                               |
| ----- | ---------------- | -------------------------------------------------------------------------------------- |
| 9.1.1 | 创建 HTTP 服务器 | 在 src/web/server.ts 中创建 Fastify/Express 服务器                                     |
| 9.1.2 | 实现 API 路由    | 实现所有 API 端点（status、toggle、config、orders、position、equity、logs、emergency） |
| 9.1.3 | 实现页面路由     | 实现页面路由（Dashboard 首页）                                                         |
| 9.1.4 | 配置服务器端口   | 从配置文件中读取端口，默认 3000                                                        |

#### 验收标准

- [ ] HTTP 服务器成功启动
- [ ] 所有 API 端点正确响应
- [ ] 页面路由正确返回 HTML
- [ ] 端口配置正确，能够通过配置文件指定

### 9.2 前端界面子阶段

#### 子任务列表

| 序号  | 子任务              | 详细描述                                  |
| ----- | ------------------- | ----------------------------------------- |
| 9.2.1 | 实现 Dashboard 页面 | 创建管理后台首页，包含状态概览卡片        |
| 9.2.2 | 实现控制面板        | 包含启动/停止按钮和紧急取消按钮           |
| 9.2.3 | 实现配置编辑器      | 显示 config.toml 内容的表单，支持提交更新 |
| 9.2.4 | 实现实时日志窗口    | 使用 HTMX 轮询 /api/logs，每 2 秒刷新     |
| 9.2.5 | 实现权益曲线图      | 使用 SVG 或 Chart.js 绘制权益变化曲线     |
| 9.2.6 | 实现 Tailwind 样式  | 使用深色主题，符合规范中的样式要求        |

#### 验收标准

- [ ] Dashboard 页面显示所有状态信息
- [ ] 启动/停止按钮能够正确控制机器人
- [ ] 紧急取消按钮能够取消所有订单（带二次确认）
- [ ] 配置编辑器能够显示和更新配置
- [ ] 日志窗口实时更新（每 2 秒）
- [ ] 权益曲线图正确显示历史数据
- [ ] 页面使用深色主题，样式符合规范
- [ ] 响应式布局，支持移动端查看

### 9.3 热重载机制子阶段

#### 子任务列表

| 序号  | 子任务           | 详细描述                                        |
| ----- | ---------------- | ----------------------------------------------- |
| 9.3.1 | 实现配置更新 API | POST /api/config 接收新配置，写入文件           |
| 9.3.2 | 触发配置热重载   | ConfigManager 监听到文件变化后触发更新          |
| 9.3.3 | 通知 BotEngine   | BotEngine 监听 configUpdated 事件，动态更新参数 |
| 9.3.4 | 前端反馈         | 更新成功后刷新配置显示区域                      |

#### 验收标准

- [ ] POST /api/config 正确接收和保存配置
- [ ] 配置文件更新后自动触发热重载
- [ ] BotEngine 正确响应配置变化
- [ ] 前端显示更新成功/失败反馈

---

## 阶段十：集成测试与优化

### 阶段目标

进行端到端集成测试，验证所有模块协同工作的正确性，确保系统满足验收标准中的所有要求。

### 10.1 错误处理与鲁棒性子阶段

#### 子任务列表

| 序号   | 子任务           | 详细描述                                                          |
| ------ | ---------------- | ----------------------------------------------------------------- |
| 10.1.1 | 实现全局异常捕获 | 在 index.ts 中设置 uncaughtException 和 unhandledRejection 处理器 |
| 10.1.2 | 实现优雅退出     | 实现 SIGTERM、SIGINT 信号处理，执行完整清理流程                   |
| 10.1.3 | 实现网络重试     | 对 RPC 请求实现指数退避重试机制                                   |
| 10.1.4 | 实现预言机容错   | 预言机价格获取失败时使用缓存价格并标记过期                        |

#### 验收标准

- [ ] 未捕获的异常正确记录日志并退出
- [ ] 未处理的 Promise 拒绝正确记录日志
- [ ] 优雅退出时正确取消所有订单
- [ ] 网络异常能够自动重试（1s, 2s, 4s）
- [ ] 预言机异常时使用缓存价格

### 10.2 集成测试子阶段

#### 子任务列表

| 序号   | 子任务         | 详细描述                                 |
| ------ | -------------- | ---------------------------------------- |
| 10.2.1 | 配置测试环境   | 使用 Drift Devnet 测试网，配置测试用私钥 |
| 10.2.2 | 测试启动模式   | 验证无仓位时自动挂买单并等待成交         |
| 10.2.3 | 测试做市模式   | 验证有仓位时同时挂买卖单                 |
| 10.2.4 | 测试订单成交   | 验证订单成交后自动取消对手方订单         |
| 10.2.5 | 测试超时逻辑   | 验证 30 秒超时后重新挂单                 |
| 10.2.6 | 测试配置热重载 | 验证运行时修改配置能够生效               |
| 10.2.7 | 测试 Web 界面  | 验证前端页面能够正确显示状态和日志       |
| 10.2.8 | 测试异常处理   | 验证各种异常情况下的系统行为             |

#### 验收标准

- [ ] 机器人能够成功连接到 Drift Devnet
- [ ] 启动模式能够在无仓位时自动挂买单
- [ ] 做市模式能够同时挂买单和只减仓卖单
- [ ] 订单成交后自动取消对手方订单
- [ ] 30 秒超时逻辑正常工作
- [ ] 预言机偏移订单能够跟随价格浮动
- [ ] 配置热重载功能正常
- [ ] 前端页面能够实时显示状态和日志
- [ ] 网络异常能够自动重试
- [ ] 异常退出时能够保存状态
- [ ] 能够优雅处理预言机价格剧烈波动
- [ ] 能够处理订单被部分成交的情况

### 10.3 性能优化子阶段

#### 子任务列表

| 序号   | 子任务           | 详细描述                   |
| ------ | ---------------- | -------------------------- |
| 10.3.1 | 优化订单响应延迟 | 确保订单响应延迟 < 1 秒    |
| 10.3.2 | 内存泄漏检查     | 确保长时间运行无内存泄漏   |
| 10.3.3 | 数据库性能优化   | 确保数据库查询响应 < 100ms |

#### 验收标准

- [ ] 订单响应延迟 < 1 秒
- [ ] 内存使用稳定，无泄漏
- [ ] 数据库查询响应 < 100ms

---

## 开发阶段总览

| 阶段 | 名称       | 主要交付物                                     | 依赖关系       |
| ---- | ---------- | ---------------------------------------------- | -------------- |
| 一   | 环境搭建   | package.json, tsconfig.json, .env, config.toml | 无             |
| 二   | 基础设施   | ConfigManager, Logger                          | 阶段一         |
| 三   | Drift 连接 | DriftClientWrapper, OracleWatcher              | 阶段二         |
| 四   | 订单执行   | OrderExecutor                                  | 阶段三         |
| 五   | 策略模块   | Strategy, types                                | 阶段四         |
| 六   | 状态机     | BotEngine, EventHandler                        | 阶段三、四、五 |
| 七   | 风控模块   | RiskManager                                    | 阶段六         |
| 八   | 数据库     | Database, AccountRepo                          | 阶段二         |
| 九   | Web 服务   | server, routes, pages                          | 阶段二、六、八 |
| 十   | 集成测试   | 完整系统                                       | 阶段一至九     |

---

## 关键里程碑

1. **里程碑一（阶段二完成）**：配置和日志系统可用，能够输出规范格式的日志
2. **里程碑二（阶段四完成）**：订单执行模块可用，能够进行原子性订单操作
3. **里程碑三（阶段六完成）**：状态机完整实现，能够进行自动化做市
4. **里程碑四（阶段九完成）**：Web 管理后台可用，能够监控和控制机器人
5. **里程碑五（阶段十完成）**：系统通过全部验收标准，可以在测试网运行

---

## 注意事项

1. 测试时必须使用 Drift Devnet 测试网，禁止在主网进行测试
2. 每个阶段完成后必须通过验收标准才能进入下一阶段
3. 所有模块必须编写单元测试，覆盖核心方法
4. 代码必须遵循 TypeScript Strict Mode 和命名规范
5. 复杂业务逻辑必须添加中文注释
6. 每次提交前必须确保代码能够编译通过
